name: Manage Custom Property Values JSON

on:
  workflow_dispatch:
    inputs:
      org_name:
        description: 'Github ORG name'
        required: true
        type: string
        default: tobedeleted321

jobs:
  get-property-json:
    runs-on: ubuntu-latest
    if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        env:
          GITHUB_OWNER: tobedeleted321
        run: |
          echo "${{ secrets.TOKEN }}" | gh auth login --with-token
      
      - name: Create custom properties backup
        env:
          ORG: ${{ github.event.inputs.org_name }}
        run: |
          NAME="${ORG}_custom_props_backup.json"
          
          echo "Creating backup for organization: ${ORG}"
          echo "Backup file: ${NAME}"
          echo ""
          
          # Write the schema to a file
          echo "{" > "${NAME}"
          echo "  \"properties\":" >> "${NAME}"
          gh api /orgs/"${ORG}"/properties/schema | jq -r 'del(.[]|.["url","source_type"])' >> "${NAME}"
          echo "}" >> "${NAME}"
          
          # Display backup contents
          echo "Backup contents:"
          cat "${NAME}"
          
          # Show property count
          PROP_COUNT=$(jq '.properties | length' "${NAME}")
          echo ""
          echo "Total properties backed up: ${PROP_COUNT}"
      
      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.org_name }}_custom_props_backup
          path: ${{ github.event.inputs.org_name }}_custom_props_backup.json
          retention-days: 90
          if-no-files-found: error
      
      # - name: Configure custom properties
      #   uses: pandaswhocode/configure-custom-properties@v1
      #   with:
      #     token: ${{ secrets.TOKEN }}
      #     config-file: ./custom_props.json
      #     organization: ${{ github.event.inputs.org_name }}
      - name: Update custom properties
        run:
          gh api -X PATCH /orgs/${{ github.event.inputs.org_name }}/properties/schema --input ./custom_props.json --silent

      - name: Update custom propertis json metadata
        env:
          ORG: ${{ github.event.inputs.org_name }}
        run: |
          NAME="custom_props.json"
          
          echo "Fetching updated custom properties for organization: ${ORG}"
          
          # Write the schema to a file
          echo "{" > "${NAME}"
          echo "  \"properties\":" >> "${NAME}"
          gh api /orgs/"${ORG}"/properties/schema | jq -r 'del(.[]|.["url","source_type"])' >> "${NAME}"
          echo "}" >> "${NAME}"
          
          echo ""
          echo "Updated custom_props.json with latest property schema"
          
          # Show property count
          PROP_COUNT=$(jq '.properties | length' "${NAME}")
          echo "Total properties: ${PROP_COUNT}"
          
          # Display updated contents
          echo ""
          echo "Updated contents:"
          cat "${NAME}"
      
      - name: Commit updated custom_props.json
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet custom_props.json; then
            echo "No changes to custom_props.json - skipping commit"
          else
            echo "Changes detected in custom_props.json"
            echo ""
            echo "Diff:"
            git diff custom_props.json
            echo ""
            
            # Add and commit
            git add custom_props.json
            git commit -m "Update custom_props.json from ${{ github.event.inputs.org_name }} org - Run ${{ github.run_number }} by ${{ github.actor }}"
            git push
            
            echo ""
            echo "âœ… Successfully committed and pushed custom_props.json"
          fi
