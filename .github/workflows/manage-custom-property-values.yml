name: Manage Custom Property Values

on:
  workflow_dispatch:
    inputs:
      property_name:
        description: 'Custom property name (e.g., project, team)'
        required: true
        type: string
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - add
          - delete
          - create_property
      value:
        description: 'Value(s) to add/delete (single value or comma-separated: value1,value2,value3). For create_property, this becomes initial allowed_values.'
        required: false
        type: string
      property_type:
        description: 'Property type (only for create_property action)'
        required: false
        type: choice
        default: single_select
        options:
          - single_select
          - multi_select
          - string
          - true_false
      property_description:
        description: 'Property description (only for create_property action)'
        required: false
        type: string
      property_required:
        description: 'Is property required? (only for create_property action)'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (show what would change without applying)'
        required: false
        default: true
        type: boolean

jobs:
  manage-property-values:
    runs-on: ubuntu-latest
    if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        env:
          GITHUB_OWNER: tobedeleted321
        run: |
          echo "${{ secrets.TOKEN }}" | gh auth login --with-token
      
      - name: Validate inputs
        env:
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
          ACTION: ${{ github.event.inputs.action }}
          VALUE: ${{ github.event.inputs.value }}
          PROPERTY_TYPE: ${{ github.event.inputs.property_type }}
          PROPERTY_DESCRIPTION: ${{ github.event.inputs.property_description }}
          PROPERTY_REQUIRED: ${{ github.event.inputs.property_required }}
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Input Validation"
          echo "Organization: $ORG_NAME"
          echo "Property Name: $PROPERTY_NAME"
          echo "Action: $ACTION"
          echo "Value: $VALUE"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          
          if [[ "$ACTION" == "create_property" ]]; then
            echo "Property Type: $PROPERTY_TYPE"
            echo "Property Description: $PROPERTY_DESCRIPTION"
            echo "Property Required: $PROPERTY_REQUIRED"
            
            # Check if property already exists
            if gh api -H "Accept: application/vnd.github+json" \
                 /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME &>/dev/null; then
              echo "::error::Property '$PROPERTY_NAME' already exists. Use 'add' action to add values to it."
              exit 1
            fi
            
            # Validate required fields for create_property
            if [[ -z "$PROPERTY_DESCRIPTION" ]]; then
              echo "::error::Property description is required when creating a property"
              exit 1
            fi
            
            # For select types, validate that values are provided
            if [[ "$PROPERTY_TYPE" == "single_select" || "$PROPERTY_TYPE" == "multi_select" ]]; then
              if [[ -z "$VALUE" ]]; then
                echo "::error::At least one value is required for $PROPERTY_TYPE properties"
                exit 1
              fi
            fi
            
            echo "::notice::Ready to create new property '$PROPERTY_NAME'"
          else
            # For add/delete actions, validate property exists
            if ! gh api -H "Accept: application/vnd.github+json" \
                 /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME &>/dev/null; then
              echo "::error::Property '$PROPERTY_NAME' does not exist"
              echo "Available properties:"
              gh api /orgs/$ORG_NAME/properties/schema | jq -r '.[].property_name'
              echo ""
              echo "To create this property, use action 'create_property'"
              exit 1
            fi
            
            # Check if property is single_select or multi_select
            EXISTING_PROPERTY_TYPE=$(gh api /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME | jq -r '.value_type')
            
            if [[ "$EXISTING_PROPERTY_TYPE" != "single_select" && "$EXISTING_PROPERTY_TYPE" != "multi_select" ]]; then
              echo "::error::Property '$PROPERTY_NAME' is type '$EXISTING_PROPERTY_TYPE'. This workflow only works with single_select or multi_select types for add/delete actions."
              exit 1
            fi
            
            # Validate value is provided for add/delete
            if [[ -z "$VALUE" ]]; then
              echo "::error::Value is required for $ACTION action"
              exit 1
            fi
            
            echo "::notice::Property '$PROPERTY_NAME' is type '$EXISTING_PROPERTY_TYPE' - compatible!"
          fi
          
          echo "::endgroup::"
      
      - name: Check organization plan
        if: github.event.inputs.action == 'create_property'
        env:
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Checking Organization Plan"
          
          echo "Fetching organization information..."
          ORG_INFO=$(gh api /orgs/$ORG_NAME 2>&1)
          
          if [[ $? -eq 0 ]]; then
            PLAN_NAME=$(echo "$ORG_INFO" | jq -r '.plan.name // "unknown"')
            echo "Organization: $ORG_NAME"
            echo "Plan: $PLAN_NAME"
            echo ""
            
            case "$PLAN_NAME" in
              "free"|"team"|"pro")
                echo "::warning::âš ï¸  Your organization is on the '$PLAN_NAME' plan"
                echo "::warning::Custom properties are NOT available on this plan"
                echo ""
                echo "Custom properties require:"
                echo "  âœ… GitHub Enterprise Cloud"
                echo "  âœ… GitHub Enterprise Server 3.14+"
                echo ""
                echo "Your plan: âŒ GitHub $PLAN_NAME"
                echo ""
                echo "The workflow will likely fail when trying to create the property."
                ;;
              "enterprise")
                echo "::notice::âœ… Organization is on Enterprise plan - custom properties should be available"
                ;;
              *)
                echo "::warning::âš ï¸  Could not determine plan type: $PLAN_NAME"
                ;;
            esac
          else
            echo "::warning::Could not fetch organization information"
            echo "Response: $ORG_INFO"
          fi
          
          echo "::endgroup::"
      
      - name: Check custom properties support
        if: github.event.inputs.action == 'create_property'
        env:
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Checking Custom Properties API"
          
          echo "Testing custom properties API endpoint..."
          echo "Endpoint: GET /orgs/$ORG_NAME/properties/schema"
          echo ""
          
          # Try to list existing properties to check if API is available
          API_RESPONSE=$(gh api /orgs/$ORG_NAME/properties/schema 2>&1)
          EXIT_CODE=$?
          
          if [[ $EXIT_CODE -eq 0 ]]; then
            echo "::notice::âœ… Custom properties API is available!"
            echo ""
            PROP_COUNT=$(echo "$API_RESPONSE" | jq '. | length')
            echo "Existing properties: $PROP_COUNT"
            
            if [[ $PROP_COUNT -gt 0 ]]; then
              echo ""
              echo "Properties found:"
              echo "$API_RESPONSE" | jq -r '.[].property_name' | sed 's/^/  - /'
            fi
          else
            echo "::error::âŒ Custom properties API is NOT available"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "API Response:"
            echo "$API_RESPONSE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            if echo "$API_RESPONSE" | grep -qi "404\|not found"; then
              echo "ğŸš« HTTP 404 - Feature Not Available"
              echo ""
              echo "Your organization '$ORG_NAME' does not have access to custom properties."
              echo ""
              echo "This is a GitHub plan limitation, not a workflow bug."
              echo ""
            elif echo "$API_RESPONSE" | grep -qi "403\|forbidden"; then
              echo "ğŸ”’ HTTP 403 - Permission Denied"
              echo ""
              echo "The GITHUB_TOKEN lacks required permissions."
              echo "Required scope: admin:org"
              echo ""
            fi
            
            echo "SOLUTIONS:"
            echo ""
            echo "1ï¸âƒ£  Test on GitHub Enterprise Server (RECOMMENDED):"
            echo "   Host: github.gwd.broadcom.net"
            echo "   Org: TNZ"
            echo "   This environment HAS custom properties âœ…"
            echo ""
            echo "2ï¸âƒ£  Use GitHub Topics instead (for github.com):"
            echo "   gh api -X PUT /repos/$ORG_NAME/REPO/topics \\"
            echo "     --input - <<<'{\"names\": [\"project-tis\", \"team-eng\"]}'"
            echo ""
            echo "3ï¸âƒ£  Upgrade to GitHub Enterprise Cloud:"
            echo "   Contact GitHub Sales"
            echo ""
            echo "For more information:"
            echo "  ğŸ“„ See GITHUB-COMPATIBILITY.md in this repository"
            echo ""
            
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Create property
        if: github.event.inputs.action == 'create_property'
        env:
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
          PROPERTY_TYPE: ${{ github.event.inputs.property_type }}
          PROPERTY_DESCRIPTION: ${{ github.event.inputs.property_description }}
          PROPERTY_REQUIRED: ${{ github.event.inputs.property_required }}
          VALUE: ${{ github.event.inputs.value }}
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Create Property"
          
          # Parse comma-separated values into JSON array
          if [[ -n "$VALUE" ]]; then
            # Split by comma, trim whitespace, and create JSON array
            ALLOWED_VALUES=$(echo "$VALUE" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            ALLOWED_VALUES="[]"
          fi
          
          echo "Property Name: $PROPERTY_NAME"
          echo "Property Type: $PROPERTY_TYPE"
          echo "Property Description: $PROPERTY_DESCRIPTION"
          echo "Property Required: $PROPERTY_REQUIRED"
          echo "Allowed Values: $ALLOWED_VALUES"
          echo ""
          
          # Build property JSON based on type
          if [[ "$PROPERTY_TYPE" == "single_select" || "$PROPERTY_TYPE" == "multi_select" ]]; then
            # Get first value as default
            DEFAULT_VALUE=$(echo "$ALLOWED_VALUES" | jq -r '.[0]')
            
            PROPERTY_JSON=$(jq -n \
              --arg name "$PROPERTY_NAME" \
              --arg type "$PROPERTY_TYPE" \
              --arg desc "$PROPERTY_DESCRIPTION" \
              --argjson required "$PROPERTY_REQUIRED" \
              --arg default "$DEFAULT_VALUE" \
              --argjson values "$ALLOWED_VALUES" \
              '{
                property_name: $name,
                value_type: $type,
                description: $desc,
                required: $required,
                default_value: $default,
                allowed_values: $values,
                values_editable_by: "org_and_repo_actors"
              }')
          else
            # For string, true_false types
            PROPERTY_JSON=$(jq -n \
              --arg name "$PROPERTY_NAME" \
              --arg type "$PROPERTY_TYPE" \
              --arg desc "$PROPERTY_DESCRIPTION" \
              --argjson required "$PROPERTY_REQUIRED" \
              '{
                property_name: $name,
                value_type: $type,
                description: $desc,
                required: $required
              }')
          fi
          
          echo "Property JSON:"
          echo "$PROPERTY_JSON" | jq '.'
          echo ""
          
          if [[ "${{ github.event.inputs.dry_run }}" == "false" ]]; then
            echo "Creating property..."
            echo "API Endpoint: POST /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME"
            echo ""
            
            # Capture both stdout and stderr
            RESPONSE=$(echo "$PROPERTY_JSON" | gh api -X PUT /orgs/$ORG_NAME/properties/schema/$name --input - 2>&1)
            EXIT_CODE=$?
            
            if [[ $EXIT_CODE -eq 0 ]]; then
              echo "::notice::âœ“ Successfully created property '$PROPERTY_NAME'"
              echo ""
              echo "Created property:"
              echo "$RESPONSE" | jq '.'
            else
              echo "::error::âŒ Failed to create property '$PROPERTY_NAME'"
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ERROR DETAILS:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "$RESPONSE"
              echo ""
              
              # Check for specific errors
              if echo "$RESPONSE" | grep -qi "404\|not found"; then
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸš« HTTP 404 - CUSTOM PROPERTIES NOT AVAILABLE"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "Your organization '$ORG_NAME' does not have access to custom properties."
                echo ""
                echo "Custom properties are ONLY available on:"
                echo "  âœ… GitHub Enterprise Cloud"
                echo "  âœ… GitHub Enterprise Server 3.14+"
                echo ""
                echo "NOT available on:"
                echo "  âŒ GitHub Free"
                echo "  âŒ GitHub Team"
                echo "  âŒ GitHub Pro"
                echo ""
                echo "To check your organization's plan:"
                echo "  gh api /orgs/$ORG_NAME | jq '.plan.name'"
                echo ""
                echo "SOLUTION:"
                echo "  1. Test this workflow on your GitHub Enterprise Server instead:"
                echo "     Host: github.gwd.broadcom.net"
                echo "     Org: TNZ"
                echo ""
                echo "  2. OR use GitHub Topics as an alternative on github.com:"
                echo "     See: GITHUB-COMPATIBILITY.md"
                echo ""
              elif echo "$RESPONSE" | grep -qi "403\|forbidden"; then
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ”’ HTTP 403 - PERMISSION DENIED"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "The token lacks required permissions."
                echo ""
                echo "Required scope: admin:org"
                echo ""
                echo "To fix:"
                echo "  1. Create a Personal Access Token with 'admin:org' scope"
                echo "  2. Add it to repository secrets as 'ORG_ADMIN_TOKEN'"
                echo "  3. Update workflow to use it"
                echo ""
              elif echo "$RESPONSE" | grep -qi "422\|unprocessable"; then
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âš ï¸  HTTP 422 - VALIDATION ERROR"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "The property configuration has invalid values."
                echo ""
                echo "Check:"
                echo "  - Property name format (lowercase, hyphens only)"
                echo "  - Required fields are provided"
                echo "  - Values are valid for the property type"
                echo ""
              else
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "â“ UNKNOWN ERROR"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "See error details above."
                echo ""
              fi
              
              echo "For more information, see:"
              echo "  ğŸ“„ GITHUB-COMPATIBILITY.md"
              echo ""
              
              exit 1
            fi
          else
            echo "::notice::ğŸ” DRY RUN - Property would be created with above configuration"
          fi
          
          echo "::endgroup::"
      
      - name: Get current property configuration
        if: github.event.inputs.action != 'create_property'
        id: current_config
        env:
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Current Configuration"
          
          # Get current property details
          PROPERTY_JSON=$(gh api /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME)
          
          echo "Current configuration:"
          echo "$PROPERTY_JSON" | jq '.'
          
          # Extract current allowed values
          CURRENT_VALUES=$(echo "$PROPERTY_JSON" | jq -r '.allowed_values[]' | sort)
          
          echo ""
          echo "Current allowed values:"
          echo "$CURRENT_VALUES"
          
          # Save to file for next step
          echo "$PROPERTY_JSON" > /tmp/property_config.json
          echo "$CURRENT_VALUES" > /tmp/current_values.txt
          
          echo "::endgroup::"
      
      - name: Calculate new values
        if: github.event.inputs.action != 'create_property'
        id: new_values
        env:
          ACTION: ${{ github.event.inputs.action }}
          VALUE: ${{ github.event.inputs.value }}
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Calculating New Values"
          
          # Read current values
          CURRENT_VALUES=$(cat /tmp/current_values.txt)
          
          # Parse comma-separated values
          IFS=',' read -ra VALUES_ARRAY <<< "$VALUE"
          
          if [[ "$ACTION" == "add" ]]; then
            NEW_VALUES="$CURRENT_VALUES"
            ADDED_COUNT=0
            SKIPPED_COUNT=0
            ADDED_VALUES=""
            SKIPPED_VALUES=""
            
            for val in "${VALUES_ARRAY[@]}"; do
              # Trim whitespace
              val=$(echo "$val" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              
              # Check if value already exists
              if echo "$CURRENT_VALUES" | grep -q "^${val}$"; then
                echo "::warning::Value '$val' already exists - skipping"
                SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
                SKIPPED_VALUES="${SKIPPED_VALUES}${val}, "
              else
                echo "::notice::Adding '$val' to allowed values"
                NEW_VALUES=$(echo -e "${NEW_VALUES}\n${val}")
                ADDED_COUNT=$((ADDED_COUNT + 1))
                ADDED_VALUES="${ADDED_VALUES}${val}, "
              fi
            done
            
            # Remove trailing comma and space
            ADDED_VALUES=${ADDED_VALUES%, }
            SKIPPED_VALUES=${SKIPPED_VALUES%, }
            
            if [[ $ADDED_COUNT -gt 0 ]]; then
              NEW_VALUES=$(echo "$NEW_VALUES" | sort)
              echo "$NEW_VALUES" > /tmp/new_values.txt
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
              echo "added_values=$ADDED_VALUES" >> $GITHUB_OUTPUT
              echo ""
              echo "âœ“ Will add $ADDED_COUNT value(s): $ADDED_VALUES"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No new values to add."
            fi
            
            if [[ $SKIPPED_COUNT -gt 0 ]]; then
              echo "âš  Skipped $SKIPPED_COUNT existing value(s): $SKIPPED_VALUES"
            fi
            
          elif [[ "$ACTION" == "delete" ]]; then
            NEW_VALUES="$CURRENT_VALUES"
            DELETED_COUNT=0
            NOTFOUND_COUNT=0
            DELETED_VALUES=""
            NOTFOUND_VALUES=""
            
            for val in "${VALUES_ARRAY[@]}"; do
              # Trim whitespace
              val=$(echo "$val" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
              
              # Check if value exists
              if ! echo "$NEW_VALUES" | grep -q "^${val}$"; then
                echo "::warning::Value '$val' does not exist - skipping"
                NOTFOUND_COUNT=$((NOTFOUND_COUNT + 1))
                NOTFOUND_VALUES="${NOTFOUND_VALUES}${val}, "
              else
                echo "::notice::Removing '$val' from allowed values"
                NEW_VALUES=$(echo "$NEW_VALUES" | grep -v "^${val}$")
                DELETED_COUNT=$((DELETED_COUNT + 1))
                DELETED_VALUES="${DELETED_VALUES}${val}, "
                
                # Check if any repos are using this value
                REPOS_USING_VALUE=$(gh api /orgs/$ORG_NAME/properties/values | \
                  jq -r --arg prop "$PROPERTY_NAME" --arg val "$val" \
                  '.[] | select(.properties[] | select(.property_name == $prop and .value == $val)) | .repository_name')
                
                if [[ -n "$REPOS_USING_VALUE" ]]; then
                  REPO_COUNT=$(echo "$REPOS_USING_VALUE" | wc -l | tr -d ' ')
                  echo "::warning::âš ï¸  $REPO_COUNT repositories are using value '$val':"
                  echo "$REPOS_USING_VALUE" | head -5 | sed 's/^/  - /'
                  if [[ $REPO_COUNT -gt 5 ]]; then
                    echo "  ... and $((REPO_COUNT - 5)) more"
                  fi
                fi
              fi
            done
            
            # Remove trailing comma and space
            DELETED_VALUES=${DELETED_VALUES%, }
            NOTFOUND_VALUES=${NOTFOUND_VALUES%, }
            
            # Check if we're removing all values
            if [[ -z "$NEW_VALUES" ]]; then
              echo "::error::Cannot remove all allowed values. At least one value must remain."
              exit 1
            fi
            
            if [[ $DELETED_COUNT -gt 0 ]]; then
              echo "$NEW_VALUES" > /tmp/new_values.txt
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
              echo "deleted_values=$DELETED_VALUES" >> $GITHUB_OUTPUT
              echo ""
              echo "âœ“ Will delete $DELETED_COUNT value(s): $DELETED_VALUES"
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "No values to delete."
            fi
            
            if [[ $NOTFOUND_COUNT -gt 0 ]]; then
              echo "âš  Skipped $NOTFOUND_COUNT non-existent value(s): $NOTFOUND_VALUES"
            fi
          fi
          
          echo "::endgroup::"
      
      - name: Show changes
        if: steps.new_values.outputs.changed == 'true' && github.event.inputs.action != 'create_property'
        env:
          ACTION: ${{ github.event.inputs.action }}
          VALUE: ${{ github.event.inputs.value }}
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
        run: |
          echo "::group::Proposed Changes"
          
          echo "Property: $PROPERTY_NAME"
          echo "Action: $ACTION"
          echo ""
          
          echo "Current allowed values:"
          cat /tmp/current_values.txt | sed 's/^/  - /'
          
          echo ""
          echo "New allowed values:"
          cat /tmp/new_values.txt | sed 's/^/  - /'
          
          echo ""
          if [[ "$ACTION" == "add" ]]; then
            echo "::notice::âœ“ Will ADD values to property '$PROPERTY_NAME'"
          else
            echo "::notice::âœ“ Will DELETE values from property '$PROPERTY_NAME'"
          fi
          
          echo "::endgroup::"
      
      - name: Apply changes
        if: steps.new_values.outputs.changed == 'true' && github.event.inputs.dry_run == 'false' && github.event.inputs.action != 'create_property'
        env:
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
          ACTION: ${{ github.event.inputs.action }}
          VALUE: ${{ github.event.inputs.value }}
          ORG_NAME: tobedeleted321
        run: |
          echo "::group::Applying Changes"
          
          # Read current property config
          PROPERTY_CONFIG=$(cat /tmp/property_config.json)
          
          # Read new values
          NEW_VALUES=$(cat /tmp/new_values.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          # Build updated property JSON
          UPDATED_CONFIG=$(echo "$PROPERTY_CONFIG" | jq --argjson new_values "$NEW_VALUES" '{
            value_type: .value_type,
            required: .required,
            default_value: .default_value,
            description: .description,
            allowed_values: $new_values,
            values_editable_by: .values_editable_by
          }')
          
          echo "Updating property '$PROPERTY_NAME'..."
          echo "Payload:"
          echo "$UPDATED_CONFIG" | jq '.'
          
          # Apply the update
          echo "$UPDATED_CONFIG" | gh api -X PUT /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME --input -
          
          if [[ $? -eq 0 ]]; then
            echo "::notice::âœ“ Successfully updated property '$PROPERTY_NAME'"
            
            # Verify the change
            echo ""
            echo "Verification - Current allowed values:"
            gh api /orgs/$ORG_NAME/properties/schema/$PROPERTY_NAME | jq -r '.allowed_values[]' | sed 's/^/  - /'
          else
            echo "::error::Failed to update property"
            exit 1
          fi
          
          echo "::endgroup::"
      
      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "::notice::ğŸ” DRY RUN MODE - No changes were applied"
          echo "::notice::To apply these changes, run the workflow again with 'dry_run: false'"
      
      - name: Create summary
        if: always()
        env:
          ACTION: ${{ github.event.inputs.action }}
          VALUE: ${{ github.event.inputs.value }}
          PROPERTY_NAME: ${{ github.event.inputs.property_name }}
          PROPERTY_TYPE: ${{ github.event.inputs.property_type }}
          PROPERTY_DESCRIPTION: ${{ github.event.inputs.property_description }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          CHANGED: ${{ steps.new_values.outputs.changed }}
        run: |
          echo "## Custom Property Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Property:** \`$PROPERTY_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** $ACTION" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$ACTION" == "create_property" ]]; then
            echo "**Property Type:** $PROPERTY_TYPE" >> $GITHUB_STEP_SUMMARY
            echo "**Description:** $PROPERTY_DESCRIPTION" >> $GITHUB_STEP_SUMMARY
            echo "**Initial Values:** \`$VALUE\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Value(s):** \`$VALUE\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Dry Run:** $DRY_RUN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$ACTION" == "create_property" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "### ğŸ” Dry Run - Property Creation Preview" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Property \`$PROPERTY_NAME\` would be created with type \`$PROPERTY_TYPE\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… Property Created" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Property \`$PROPERTY_NAME\` has been created successfully!" >> $GITHUB_STEP_SUMMARY
            fi
          elif [[ "$CHANGED" == "true" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "### ğŸ” Dry Run - Changes Preview" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The following changes would be applied:" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âœ… Changes Applied" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The following changes were applied:" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Current values:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/current_values.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**New values:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/new_values.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [[ "$ACTION" == "add" ]]; then
              echo "All provided values already exist in property \`$PROPERTY_NAME\`" >> $GITHUB_STEP_SUMMARY
            elif [[ "$ACTION" == "delete" ]]; then
              echo "None of the provided values exist in property \`$PROPERTY_NAME\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Executed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/property_config.json /tmp/current_values.txt /tmp/new_values.txt || true
